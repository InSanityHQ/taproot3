<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-09-27 Mon 11:53 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Data-Oriented Design and C++</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Taproot" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" href="/global.css" type="text/css"/>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="preamble" class="status">
<div class="header"><span class="site"><a href="https://taproot3.sanity.gq">TR3.5</a></span></div><div class="datarow"><h1 class="title">Data-Oriented Design and C++</h1> <h2 class="subtitle"></h2> <span class="author">Taproot</span> <span class="date">2021-09-27 Mon 11:51</date></div>
</div>
<div id="content">
<div id="linktables"><div id="table-of-backlinks"><h2>Backlinks</h2><ul><li><a class='backlink' href='lowlevel.html'>Low-Level Programming</a></li> </ul></div><div id="table-of-contents"><h2>Table of Contents</h2><div id="text-table-of-contents">
<ul>
<li><a href="#orgc9570b3">1. What is Data-Oriented Design?</a>
<ul>
<li><a href="#org42583f3">1.1. Three Big Lies</a>
<ul>
<li><a href="#orgf0d8c2d">1.1.1. Software is a platform.</a></li>
<li><a href="#orge0d8252">1.1.2. Code should be designed around your mental model of the world.</a></li>
<li><a href="#orgee3e43d">1.1.3. Code is more important than data.</a></li>
</ul>
</li>
<li><a href="#org00fbcde">1.2. Results of TBL</a></li>
</ul>
</li>
<li><a href="#org0003c13">2. Example: Dictionary Lookup</a>
<ul>
<li><a href="#org8b87839">2.1. Code-First design</a></li>
<li><a href="#orgf72c54c">2.2. Data-First design</a></li>
</ul>
</li>
<li><a href="#orge743e2b">3. Cache Times</a></li>
<li><a href="#org07486da">4. Improvements</a></li>
<li><a href="#org13de833">5. Questions</a></li>
</ul>
</div></div>
</div>

<div id="outline-container-orgc9570b3" class="outline-2">
<h2 id="orgc9570b3"><span class="section-number-2">1</span> What is Data-Oriented Design?</h2>
<div class="outline-text-2" id="text-1">
<p>
<i>The purpose of all programs is to transform data.</i> 
</p>

<ul class="org-ul">
<li>If you don't understand the data you're working with, you don't understand the problem (and conversely, understanding it more means you understand the problem).</li>
<li>Also, different data = different problems.</li>
<li>Understanding the problem also relies on understanding the cost of the things you're doing (and therefore hardware as well).</li>
<li>Optimizing on problems you probably don't have creates problems you do.</li>
<li>More context, better solution. Data is important for this.</li>
<li>Reason must prevail - pragmatism over theory.</li>
</ul>
</div>
<div id="outline-container-org42583f3" class="outline-3">
<h3 id="org42583f3"><span class="section-number-3">1.1</span> Three Big Lies</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orgf0d8c2d" class="outline-4">
<h4 id="orgf0d8c2d"><span class="section-number-4">1.1.1</span> Software is a platform.</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
Obviously hardware is the platform, and solutions are different for different sets of hardware. x86 vs ARM is different due to varying constraints (and therefore you need to consider <a href="lowlevel.html">low-level</a> things). Reality is not something you're forced to deal with but the actual problem itself (pragmatism &gt; theory).
</p>
</div>
</div>
<div id="outline-container-orge0d8252" class="outline-4">
<h4 id="orge0d8252"><span class="section-number-4">1.1.2</span> Code should be designed around your mental model of the world.</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
This ends up hiding data - and that's bad since trading maintenance for understanding of the data makes the problem harder to solve. Classes are similar in real life but not in code so you end up with strange monolithic and unrelated data structures. Too abstract of a solution and divorced from reality.
</p>
</div>
</div>
<div id="outline-container-orgee3e43d" class="outline-4">
<h4 id="orgee3e43d"><span class="section-number-4">1.1.3</span> Code is more important than data.</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
Code is only for transforming data. Programmers are responsible for solving data transformation problems, not just writing code. And in order to do solve these problems you need to understand the data, and idealized abstract solutions don't work since they ignore the <b>actual</b> data you're working with.
</p>
</div>
</div>
</div>
<div id="outline-container-org00fbcde" class="outline-3">
<h3 id="org00fbcde"><span class="section-number-3">1.2</span> Results of TBL</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>Poor performance</li>
<li>Poor concurrency</li>
<li>Poor optimizability</li>
<li>Poor stability</li>
<li>Poor testability</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org0003c13" class="outline-2">
<h2 id="org0003c13"><span class="section-number-2">2</span> Example: Dictionary Lookup</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org8b87839" class="outline-3">
<h3 id="org8b87839"><span class="section-number-3">2.1</span> Code-First design</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Something like this in memory, since we view these as being associated with each other:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Key</td>
<td class="org-left">Value</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
This isn't actually the case. Most of the time it's only the keys that matter since those are used for the lookup. This kills performance since now you're loading the value into the cache each time only to immediately throw it away.
</p>
</div>
</div>
<div id="outline-container-orgf72c54c" class="outline-3">
<h3 id="orgf72c54c"><span class="section-number-3">2.2</span> Data-First design</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Have them separate, and only the keys will be in cache (yes the value will be a cold lookup that causes a cache miss, but the statistical chance is low). <i>Always solve for the common case first.</i>
</p>
</div>
</div>
</div>
<div id="outline-container-orge743e2b" class="outline-2">
<h2 id="orge743e2b"><span class="section-number-2">3</span> Cache Times</h2>
<div class="outline-text-2" id="text-3">
<p>
The most expensive operations are transcendentals at ~100 cycles and square roots at ~25 cycles. In comparison, L1 lookups take 3, L2 take 20+, and RAM 300+ cycles. L1 is great, L2 is decent, and RAM is painfully slow. Because of this, this means L2 cache misses are the most important events when it comes to understanding performance. 
</p>

<p>
The compiler spends its time optimizing everything besides the waiting times for cache lines - because it <i>can't</i> solve them.
</p>
</div>
</div>
<div id="outline-container-org07486da" class="outline-2">
<h2 id="org07486da"><span class="section-number-2">4</span> Improvements</h2>
<div class="outline-text-2" id="text-4">
<p>
:collapsed: true
</p>
<ul class="org-ul">
<li>Make sure the whole line is filled with data: make the most out of your reads.
<ul class="org-ul">
<li>Things don't just exist in a void most of the time so make sure to pack them together to achieve this.</li>
</ul></li>
<li>Don't put bools in structs - very low information density so cache is wasted and this likely bumps other more important things beyond the cache</li>
<li>Compilers aren't amazing at optimizing reads/writes - so make sure to not perform unnecessary ones.</li>
<li>"Hoist" (bring the the outside) all loop invariants (even simple ones)</li>
</ul>


<p>
Want to see information density of bools? Just dump value and compress it.
</p>
</div>
</div>
<div id="outline-container-org13de833" class="outline-2">
<h2 id="org13de833"><span class="section-number-2">5</span> Questions</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>How do you avoid code duplication without STL/templates?
<ul class="org-ul">
<li>It's not that large of a problem, but ultimately you can just generate the code.</li>
</ul></li>
<li>How do you deal with variety of platforms and the situations your code will be run in?
<ul class="org-ul">
<li>Unlikely that the range if very large and that you don't knnow anything.</li>
</ul></li>
<li>What about non performance-heavy industries?
<ul class="org-ul">
<li>Performance matters everywhere, even to users.</li>
</ul></li>
<li>What about portability?
<ul class="org-ul">
<li>Optimize for a specific range.</li>
</ul></li>
</ul>
</div>
</div>
</div>
</body>
</html>
