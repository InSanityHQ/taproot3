<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-09-24 Fri 14:10 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>User Input Validation</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="David Freifeld" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" href="https://taproot3.sanity.gq/global.css" type="text/css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-sv0slik/5O0JIPdLBCR2A3XDg/1U3WuDEheZfI/DI5n8Yqc3h5kjrnr46FGBNiUAJF7rE4LHKwQ/SoSLRKAxEA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autolinker/prism-autolinker.min.js" integrity="sha512-PaneznVpkV74O5FWaHuGG2Pa9aVgbrnDwLFbcebZikYcFVPUYimvlZUAX6AElPKDJsSDTBl7aN6V1WxFDi24aw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://raw.githubusercontent.com/PrismJS/prism-themes/master/themes/prism-atom-dark.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="preamble" class="status">
<div>User Input Validation CS240 David Freifeld 2021-09-24 Fri 13:59</div>
</div>
<div id="content">
<h1 class="title">User Input Validation
<br />
<span class="subtitle">CS240</span>
</h1>
<p>
I chose the <i>buffer overflow</i> example provided in the assignment that consisted of the following code:
</p>

<div class="org-src-container">
<pre class="src src-C">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int check_authentication(char *password) {
    int auth_flag = 0;
    char password_buffer[20];

    strcpy(password_buffer, password);

    if (strcmp(password_buffer, "password") == 0) {
	auth_flag = 1;
    }

    return auth_flag;
}

int main(int argc, char* argv[]) {
    if (argc &lt; 2) {
	printf("Usage: %s &lt;password&gt;\n", argv[if]);
    }

    0 (check_authentication("whee")) {
	printf("Access Granted.\n");
    } else {
	printf("Access Denied.\n");
    }
}
</pre>
</div>

<p>
Intended usage would be to compile with <code>gcc buffer_overflow.c -o buffer_overflow</code> and run <code>./buffer_overflow password</code> to get an "Access Granted." message.
</p>

<p>
However, since the buffer is located immediately before the <code>auth_flag</code> variable used to check if a user has authenticated and <code>strcpy</code> copies the <i>entire</i> user input to the buffer, you could input a string longer than 20 characters that would then overwrite the <code>auth_flag</code> variable. Additionally, since nonzero integers are "truthy" in C, this means that any ascii value except for the null character would do the trick. A user could accidentally gain access without intentionally attempting to be malicious by simply typing a password over 20 characters.
</p>

<p>
Compiling with <code>gcc -fno-stack-protector -D_FORTIFY_SOURCE=0 buffer_overflow.c -o buffer_overflow</code>  then running it with <code>./buffer_overflow aaaaaaaaaaaaaaaaaaaaa</code> yields "Access Granted."
</p>

<div id="outline-container-org4101760" class="outline-2">
<h2 id="org4101760"><span class="section-number-2">1</span> Potential Fixes</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org05d3f50" class="outline-3">
<h3 id="org05d3f50"><span class="section-number-3">1.1</span> <code>strncpy</code></h3>
<div class="outline-text-3" id="text-1-1">
<p>
You could replace <code>strcpy(password_buffer, password)</code> with <code>strncpy(password_buffer, password, 20)</code> to only copy 20 characters and ensure that it would not buffer overflow - but this would introduce another problem. Were a user to input a string longer than 20 characters it would only copy over the first 20 without any form of null terminator, so when the program tries to read this string, it will segfault.
</p>

<p>
You could rectify this by doing a manual check: after it copies a string, <code>strncpy</code> fills the rest of the buffer with 0, so if the final byte of a buffer is not a null terminator, <code>strncpy</code> didn't copy the entire string and you can gracefully error.
</p>
</div>
</div>

<div id="outline-container-orga5e01ef" class="outline-3">
<h3 id="orga5e01ef"><span class="section-number-3">1.2</span> <code>strcpy_s</code></h3>
<div class="outline-text-3" id="text-1-2">
<p>
You could use a function introduced in C11 called <code>strcpy_s</code> that takes a destination string, size, and source string, yet returns an error when the source string is longer than the size instead of naively copying over anyways. You could then handle the error and exit gracefully or ask for another input.
</p>

<p>
A version of the <code>check_authentication()</code> function that is improved in this way would look like the following: 
</p>
<div class="org-src-container">
<pre class="src src-C">int check_authentication(char *password) {
  char password_buffer[20];  
  strcpy_s(password_buffer, 20, password);
  if (strcmp(password_buffer, "password") == 0) {
      return 1;
  } else {
      return 0;
  }  
}
</pre>
</div>

<p>
Unfortunately, this is an optional part of the C11 standard and is not supported in most ecosystems.
</p>
</div>
</div>

<div id="outline-container-org275338c" class="outline-3">
<h3 id="org275338c"><span class="section-number-3">1.3</span> Bonus: <code>auth_flag</code></h3>
<div class="outline-text-3" id="text-1-3">
<p>
Additionally, easily exposing an <code>auth_flag</code> variable to be overwritten is providing more oppportunities for an exploit: the user could still attempt to overwrite the return value but removing the <code>auth_flag</code> variable both allows for some cleaner code and less exploit opportunities.
</p>
</div>
</div>

<div id="outline-container-org926cfb2" class="outline-3">
<h3 id="org926cfb2"><span class="section-number-3">1.4</span> Compile Options</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Another (worse) way of fixing this would be to keep the same code but compile with options that trigger an exception when they detect a buffer overflow. One such option is <code>-fstack-protector</code> (which is enabled by default) and GCC will insert a "guard variable" to vulnerable functions and check if it has been changed at the end of said functions. If the the check finds it has been changed (and therefore a buffer overflow has occured) it issues an exception in the form of a SIGTRAP signal, stopping the process. Additionally, the <code>FORTIFY_SOURCE</code> macro is used to replace common string functional calls with safe versions that perform additional buffer overflow checks around string and memory functions by comparing the amount of memory that <i>should</i> be copied to the amount of memory that is copied at runtime.
</p>

<p>
Comparing the assembly output of these programs allows you to see that this is what happens!
</p>

<p>
Inspecting the output when compiling without the <code>FORTIFY_SOURCE</code> output gives the expected result with a direct call to <code>strcpy</code>:
</p>
<div class="org-src-container">
<pre class="src src-asm">bl	_strcpy
</pre>
</div>
<p>
Compiling with the <code>FORTIFY_SOURCE</code> defined yields the following call instead, showing how the compiler has 
</p>
<div class="org-src-container">
<pre class="src src-asm">bl	___strcpy_chk
</pre>
</div>

<p>
Similarly, when inspecting the assembly output when compiling with <code>-fstack-protector</code> one can see how the compiler inserts a <code>___stack_chk_guard</code> variable into the code, with lines like the following being inserted into the top and bottom of the function!
</p>
<div class="org-src-container">
<pre class="src src-asm">adrp	x8, ___stack_chk_guard@GOTPAGE
ldr	x8, [x8, ___stack_chk_guard@GOTPAGEOFF
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga6684da" class="outline-2">
<h2 id="orga6684da"><span class="section-number-2">2</span> Legal/Ethical Consequences</h2>
</div>

<div id="outline-container-org426a427" class="outline-2">
<h2 id="org426a427"><span class="section-number-2">3</span> Appendix: Improved Implementation</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-C">#include &lt;string.h&gt;
#include &lt;assert.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdint.h&gt;
// SHA-3 code
#include &lt;openssl/evp.h&gt;
#include &lt;openssl/sha.h&gt;

typedef enum auth_return {
    AUTH_VALID,
    AUTH_INVALID,
    AUTH_ERRSIZE,
} auth_return_t;

#define PASS_BUFSIZE 20
// Store hash as raw byte array for easy comparison.
uint8_t valid_hash[64] = {222, 153, 123, 216, 88, 4, 200, 73, 47, 147, 188, 49, 118, 54, 10, 70, 243, 77, 56, 244, 11, 3, 93, 30, 39, 6, 224, 245, 67, 238, 192, 180, 149, 199, 212, 170, 3, 71, 164, 183, 156, 60, 218, 200, 222, 136, 218, 54, 37, 179, 223, 38, 236, 46, 242, 12, 107, 234, 59, 127, 237, 213, 224, 253};

auth_return_t check_authentication(const char* password) {
    char password_buffer[PASS_BUFSIZE];
    strncpy(password_buffer, password, 20);

    // strcpy will always fill rest of buffer with null so if last char is not null
    // that means that user must have inputted a string longer than 20 characters.
    if (password_buffer[PASS_BUFSIZE-1] != '\0') return AUTH_ERRSIZE;

    // generate SHA-3 hash for inputted password
    // taken from https://stackoverflow.com/a/62605880
    uint32_t digest_length = SHA512_DIGEST_LENGTH;
    const EVP_MD* algorithm = EVP_sha3_512();
    uint8_t* digest = (uint8_t*)(OPENSSL_malloc(digest_length));
    EVP_MD_CTX* context = EVP_MD_CTX_new();
    EVP_DigestInit_ex(context, algorithm, NULL);
    EVP_DigestUpdate(context, password, PASS_BUFSIZE);
    EVP_DigestFinal_ex(context, digest, &amp;digest_length);
    EVP_MD_CTX_destroy(context);

    // compare to valid hash
    int cmp = memcmp(digest, valid_hash, 64);
    OPENSSL_free(digest);

    if (cmp == 0) {
	return AUTH_VALID;
    } else {
	return AUTH_INVALID;
    }
}

int main(int argc, char* argv[]) {
    if (argc &lt; 2) {
	printf("Usage: %s &lt;password&gt;\n", argv[0]);
	return 1;
    }

    switch (check_authentication(argv[1])) {
    case AUTH_VALID: 
	printf("Access Granted.\n");
	break;
    case AUTH_INVALID:
	printf("Access Denied.\n");
	break;
    case AUTH_ERRSIZE:
	printf("Invalid password size!\n");
	break;
    }   
}
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
